# Изменения в системе работы с изображениями

## Дата: 2025-01-19

### Добавлено

#### 1. Crop-редактор изображений
- **Файлы:**
  - `app/admin/components/imageCropModal/index.tsx`
  - `app/admin/components/imageCropModal/index.module.scss`
  - `app/utils/cropImage.ts`

- **Функциональность:**
  - Визуальная обрезка изображений перед загрузкой
  - Выбор соотношения сторон (1:1, 3:2, 2:3, 16:9, свободно)
  - Масштабирование (zoom)
  - Поворот изображения
  - Предпросмотр в реальном времени

#### 2. Скрипт миграции изображений
- **Файл:** `scripts/migrate-images.ts`
- **Команды:**
  ```bash
  pnpm migrate:images          # Миграция
  pnpm migrate:images:dry      # Пробный прогон
  ```
- **Назначение:** Регенерация старых изображений с прозрачным фоном

#### 3. Документация
- `IMAGE_MIGRATION_GUIDE.md` - Руководство по миграции
- `CHANGELOG_IMAGES.md` - Этот файл

### Изменено

#### 1. API Upload (`app/api/upload/route.ts:125`)
```diff
- const bg = { r: 255, g: 255, b: 255, alpha: 1 }  // Белый фон
+ const bg = { r: 255, g: 255, b: 255, alpha: 0 }  // Прозрачный фон
```
**Эффект:** Новые изображения больше не имеют белых полей

#### 2. Admin Form (`app/admin/components/adminForm/index.tsx`)
- Добавлен crop-редактор для главного изображения и галереи
- Добавлено превью загруженного изображения
- Добавлены подсказки о рекомендуемых размерах
- Изменена логика загрузки: файл → crop → upload → save

#### 3. Image Variants (`app/lib/imageVariants.ts`)
- Добавлены проверки на пустые URL
- Добавлены комментарии об обратной совместимости

### Зависимости

#### Добавлено:
- `react-easy-crop: ^5.5.3`

### Обратная совместимость

✅ **Полностью сохранена:**
- Существующие изображения продолжают работать
- Структура файлов не изменилась
- API остался прежним
- Компоненты работают со старыми и новыми изображениями

### Миграция

#### Автоматически (для новых изображений):
- Все новые загрузки автоматически используют прозрачный фон
- Crop-редактор появляется при каждой загрузке

#### Вручную (для существующих изображений):
```bash
# 1. Пробный прогон
pnpm migrate:images:dry

# 2. Миграция
pnpm migrate:images

# 3. Принудительная перезапись (опционально)
pnpm migrate:images -- --force
```

### Архитектура

#### До изменений:
```
Выбор файла → Загрузка → Sharp (белый фон) → Сохранение
```

#### После изменений:
```
Выбор файла → Crop-редактор → Загрузка → Sharp (прозрачный фон) → Сохранение
```

### Размеры изображений

Остались без изменений:
- `__source.webp`: до 2000x2000px (качество 90%)
- `__card.webp`: 260x260px (качество 82%)
- `__detail.webp`: 460x299px (качество 82%)
- `__thumb.webp`: 106x69px (качество 82%)

### Решенные проблемы

1. ✅ Белые поля на изображениях с непрозрачностью
2. ✅ Отсутствие контроля над обрезкой
3. ✅ Непонимание заказчиком требуемых размеров
4. ✅ Проблемы с не-PNG форматами

### Известные ограничения

- Максимальный размер файла: 2MB (без изменений)
- Поддерживаемые форматы: JPEG, PNG, WebP, GIF
- Crop работает только в браузерах с поддержкой Canvas API

### Тестирование

Рекомендуется протестировать:
1. ✅ Загрузку нового изображения с crop
2. ✅ Загрузку в галерею
3. ✅ Отображение старых изображений
4. ✅ Скрипт миграции (dry-run)
5. ✅ Мобильную версию crop-редактора

### Команды для проверки

```bash
# Проверка типов
pnpm types

# Запуск dev-сервера
pnpm dev

# Миграция изображений (пробный прогон)
pnpm migrate:images:dry

# Сборка проекта
pnpm build
```

### Rollback Plan

В случае проблем:

1. **Откат crop-функционала:**
   ```bash
   git revert <commit-hash>
   ```

2. **Восстановление старой обработки фона:**
   ```typescript
   // app/api/upload/route.ts:125
   const bg = { r: 255, g: 255, b: 255, alpha: 1 }
   ```

3. **Удаление зависимости:**
   ```bash
   pnpm remove react-easy-crop
   ```

### Производительность

- Crop выполняется на клиенте (без нагрузки на сервер)
- Canvas API - встроенный, нет внешних запросов
- Скрипт миграции: ~1-2 сек на изображение
- Размер бандла: +~15KB (react-easy-crop gzipped)

### Безопасность

- Без изменений: все проверки остались
- Magic bytes validation работает
- Rate limiting применяется
- Аутентификация обязательна

---

**Автор изменений:** Claude Code
**Дата внедрения:** 2025-01-19
**Версия:** compauto-next v0.1.0
