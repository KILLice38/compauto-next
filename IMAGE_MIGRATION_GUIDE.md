# Руководство по миграции изображений

## Что изменилось?

### Старая реализация
- ❌ Белый непрозрачный фон при resize
- ❌ Нет возможности обрезки изображений
- ❌ Заказчик не понимал, какие размеры нужны
- ❌ Проблемы с не-PNG изображениями

### Новая реализация
- ✅ **Прозрачный фон** - нет белых полей
- ✅ **Crop-редактор** - визуальная обрезка перед загрузкой
- ✅ **Превью результата** - видно, как будет выглядеть
- ✅ **Подсказки** - рекомендуемые пропорции
- ✅ **Обратная совместимость** - старые изображения продолжают работать

## Миграция существующих изображений

### Шаг 1: Проверка (Dry Run)

Сначала посмотрите, что будет изменено:

```bash
pnpm migrate:images:dry
```

Это покажет:
- Сколько изображений будет обработано
- Какие файлы будут созданы
- Никаких изменений не применится

### Шаг 2: Миграция

Запустите миграцию:

```bash
pnpm migrate:images
```

Скрипт:
- Найдет все `__source.webp` файлы
- Регенерирует варианты с прозрачным фоном
- Пропустит уже обработанные файлы
- Покажет статистику

### Шаг 3: Принудительная миграция (опционально)

Если нужно перезаписать ВСЕ варианты:

```bash
pnpm migrate:images -- --force
```

⚠️ **Внимание:** Это перезапишет все существующие варианты изображений!

## Структура изображений

### До миграции
```
public/uploads/products/турбокомпрессор-k03/
├── турбокомпрессор-k03__source.webp  (оригинал)
├── турбокомпрессор-k03__card.webp    (260x260, БЕЛЫЙ ФОН)
├── турбокомпрессор-k03__detail.webp  (460x299, БЕЛЫЙ ФОН)
└── турбокомпрессор-k03__thumb.webp   (106x69, БЕЛЫЙ ФОН)
```

### После миграции
```
public/uploads/products/турбокомпрессор-k03/
├── турбокомпрессор-k03__source.webp  (оригинал)
├── турбокомпрессор-k03__card.webp    (260x260, ПРОЗРАЧНЫЙ ФОН)
├── турбокомпрессор-k03__detail.webp  (460x299, ПРОЗРАЧНЫЙ ФОН)
└── турбокомпрессор-k03__thumb.webp   (106x69, ПРОЗРАЧНЫЙ ФОН)
```

## Работа с новой системой

### Для администраторов

1. **Загрузка главного изображения:**
   - Выберите файл
   - Откроется редактор обрезки
   - Настройте область, масштаб, поворот
   - Нажмите "Применить"

2. **Загрузка в галерею:**
   - Аналогично главному изображению
   - Можно добавить до 4 фото

3. **Рекомендации:**
   - Используйте квадратное соотношение 1:1
   - Минимальный размер: 800x800px
   - Форматы: JPG, PNG, WebP, GIF
   - Максимальный размер: 2MB

### Для разработчиков

Система автоматически работает со старыми и новыми изображениями:

```tsx
import { variantUrl } from '@/app/lib/imageVariants'

// Работает с любыми изображениями
<Image src={variantUrl(product.img, 'card')} ... />
```

## Откат изменений

Если что-то пошло не так:

1. **Восстановление из бэкапа:**
   ```bash
   # Если делали бэкап
   cp -r public/uploads.backup/* public/uploads/
   ```

2. **Регенерация из source:**
   ```bash
   # Source файлы не затрагиваются, можно пересоздать варианты
   pnpm migrate:images -- --force
   ```

## Частые вопросы

### Q: Что произойдет со старыми изображениями?
A: Они продолжат работать. Миграция только улучшит их качество.

### Q: Нужно ли мигрировать сразу?
A: Нет, можно постепенно. Новые изображения автоматически создаются с прозрачным фоном.

### Q: Что если у меня нет изображений?
A: Скрипт просто сообщит об этом и завершится. Все новые изображения будут правильными.

### Q: Безопасно ли это?
A: Да, скрипт не удаляет `__source.webp` файлы. В худшем случае можно регенерировать варианты.

### Q: Сколько времени займет миграция?
A: Зависит от количества изображений. Примерно 1-2 секунды на изображение.

## Поддержка

При проблемах проверьте:
1. Права доступа к директории `public/uploads/`
2. Наличие пакета `sharp` в dependencies
3. Логи выполнения скрипта

Все изменения логируются в консоль с подробным описанием.
