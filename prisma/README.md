# Prisma Database Setup

## Миграции

### Создание новой миграции
```bash
pnpm prisma migrate dev --name migration_name
```

### Применение миграций (production)
```bash
pnpm prisma migrate deploy
```

### Сброс базы данных
```bash
pnpm prisma migrate reset
```

## Seed (Заполнение тестовыми данными)

### Быстрый старт

Для быстрого заполнения новой базы данных тестовыми товарами:

```bash
# 1. Применить миграции
pnpm prisma migrate dev

# 2. Заполнить базу тестовыми данными
pnpm db:seed
```

### Что делает seed скрипт?

Скрипт `prisma/seed.ts` автоматически:

1. **Очищает базу данных** - удаляет все существующие товары
2. **Создает 14 тестовых товаров** с данными:
   - Название (турбокомпрессоры различных моделей)
   - Описание
   - Цена (18,000 - 72,000 руб)
   - Марка автомобиля (Volkswagen, Audi, Mercedes-Benz и др.)
   - Модель двигателя
   - Тип компрессора
   - 5 пунктов детального описания
3. **Генерирует изображения** для каждого товара:
   - Главное изображение
   - Галерея из 2-4 изображений
   - Все варианты (source, card, detail, thumb)
   - Изображения сохраняются в `/public/uploads/seed/`

### Созданные товары

| № | Модель | Марка | Двигатель | Цена |
|---|--------|-------|-----------|------|
| 1 | GT1749V | Volkswagen | TDI 1.9 | 25,000₽ |
| 2 | K03 | Audi | TFSI 1.8 | 32,000₽ |
| 3 | GT2056V | Mercedes-Benz | OM642 | 45,000₽ |
| 4 | K04 | Volkswagen | TSI 2.0 | 38,000₽ |
| 5 | GT1544V | Peugeot | HDi 1.6 | 22,000₽ |
| 6 | HX35W | Cummins | 6BT 5.9 | 48,000₽ |
| 7 | GT1752S | Renault | dCi 1.5 | 28,000₽ |
| 8 | K16 | Porsche | M96/97 | 65,000₽ |
| 9 | GT2260V | BMW | N54B30 | 52,000₽ |
| 10 | TD04 | Subaru | EJ20 | 35,000₽ |
| 11 | GT1238S | Smart | M160 | 18,000₽ |
| 12 | HX40W | Iveco | F1C | 55,000₽ |
| 13 | K03S | Audi | AEB 1.8T | 36,000₽ |
| 14 | GT2871R | Universal | Custom | 72,000₽ |

### Повторный запуск

Можно запускать скрипт многократно - он очистит базу и создаст товары заново:

```bash
pnpm db:seed
```

**Внимание:** Скрипт удаляет ВСЕ существующие товары из базы!

### Только изображения

Изображения генерируются автоматически с помощью Sharp в виде простых цветных заглушек:
- Каждый товар имеет уникальный цвет
- Изображения в галерее имеют вариации цвета
- Все форматы WebP
- Сохраняются в `/public/uploads/seed/<slug>/`

### Очистка seed данных

Для удаления всех тестовых товаров и изображений:

```bash
# Удалить товары из БД
pnpm prisma studio
# Вручную удалить записи

# Удалить изображения
rm -rf public/uploads/seed/

# Или запустить seed заново - он всё очистит сам
pnpm db:seed
```

## Prisma Studio

Для просмотра и редактирования данных в браузере:

```bash
pnpm prisma studio
```

Откроется по адресу: http://localhost:5555

## Генерация Prisma Client

После изменения схемы:

```bash
pnpm prisma generate
```

## Troubleshooting

### Ошибка подключения к БД
Проверьте `DATABASE_URL` в `.env`:
```
DATABASE_URL="postgresql://user:password@localhost:5432/dbname?schema=public"
```

### Seed падает с ошибкой Sharp
Убедитесь, что Sharp установлен:
```bash
pnpm install sharp
```

### Нет прав на создание директорий
Проверьте права на папку `public/uploads/`:
```bash
chmod -R 755 public/uploads/
```
